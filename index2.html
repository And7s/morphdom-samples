<html>

<script type="text/javascript" src="morphdom.js"></script>
<script type="text/javascript" src="handlebars-v4.0.11.js"></script>
<script type="text/javascript" src="lodash.min.js"></script>
<script type="text/javascript" src="jquery-3.3.1.min.js"></script>
<body>

    <h1>Hello world</h1>

    <div id="app">
        this will be the app
    </div>

I CAN initialise the components seperately, butmultiple of one kind will casue a clash as they might share some same context
my solutin is to save the object and reinitialise on every compoenent creation

    <script type="text/javascript">
        /* currently unsanswered questions

            how to pass data down to components as the template enging does not know about the JS structure of you app
            data structure and dom structure have to be handled by the same framework, as they are coupled.
            Decoupling them does not work (only if they do NOT share any state at all)
        */

        var Component = function(tagName, comp) {
            console.log('register a new component on', tagName);
            var state = {
                count: 0,
                parentCounter: 0
            };
            var _el;

            this.dispatch = function(action) {
                console.log("YEAASASD dispatch");

                state.count += action;
                render();
            };  

            this.getState = function() {
                return state;
            };

            this.methods = {};
            this.methods.increment = comp.methods.increment(this.dispatch, this.getState);



            var self = this;
            this.state = {a:6};
            
            function init() {

            }

            function render() {
                //var html = renderComponent(state, props);
                console.log('el', _el);

                morphdom(_el, "<div>" + comp.render(state) + "</div>", {
                    childrenOnly: true
                });
            }

            

            function update(newState) {
                state = newState;
                state.parentCounter++;
                console.log('component got the new context', newState);
                render(); 
            }

            this._eval = function(functionName) {
                console.log('called _eval with', this);
                console.log('event', event);

                var str = 'this.methods.' + functionName;
                console.log('eva ',str)
   
                eval( str );

            }


            function bindEvents() {
                console.log('bind ev')
                 $(_el).on('click', '[data-on-click]', function(event) {
                    console.log('event', event);
                    var fn = $(this).data('on-click');
                    console.log('attribute', fn);
                    try {
                        


                           // _eval(fn, event);
                        _eval.call(self, fn);
                       //_eval(fn)
                    } catch(e) {
                        console.log('error', e)
                    }
                })
            }

            return function(el) {
                _el = el;
                console.log('this', this)
                console.log('initialise instance on ', _el);

                init();

                render();
                bindEvents();

                 


                return {
                    update: update
                }
            }
        };

        function Component2(tag, obj) {
            return Component(tag, obj);
        }
        var myComponent2 = Component2('comp2', {
            render: function(props) { 
                return `
                <div>
                    component life is cool
                    ` + props.count + `
                    parentCounter: ` + props.parentCounter + `
                    <button data-on-click="increment(event, 5, 'hi')">Increment the component</button>
                </div>
            `},
            methods: {
                increment: function(dispatch, getState) {

                    return function(event) {
                        dispatch(5);
                        console.log('state', getState());
                        console.log('event', event);
                        console.log(this);
                        console.log(render);
                    }
                    
                }
            }

        });

        var comp3Obj = {
            render: function(props) { 
                return `
                <div>
                    component life is cool
                    ` + props.count + `
                    parentCounter: ` + props.parentCounter + `
                    <button data-on-click="increment(event, 5, 'hi')">Increment the component</button>
                </div>
            `},
            methods: {
                increment: function(dispatch, getState) {

                    return function(event) {
                        dispatch(5);
                        console.log('state', getState());
                        console.log('event', event);
                        console.log(this);
                        console.log(render);
                    }
                    
                }
            }

        };
        var myComponent3 = new Component('comp3', comp3Obj);


        var renderApp = function(ctx) {
            return `
            <div><comp2></comp2></div>
            <div><comp2></comp2></div>
            <div><comp3></comp3></div>`;

            return `
            <div>
                hello no template enginge
                <button data-on-click="myFn(1, event)">Increment</button>
                <div>body:` + ctx.body + ` updated: ` + ctx.counter + `</div>
                component?
<hr>
                
                <hr>
                <div><comp2>inside</comp></div>
                another?

                ` + ((ctx.counter % 2 == 0) ? `Yes` : ` no`) + `

                ` + ((ctx.counter % 2 == 0) ? `<div><div>inside</div></div>` : ``) + `
            </div>
            `;  

        }

        var renderComponent = function(ctx, props) {
            with(ctx) {
                return `
                <div>
                    component life is cool
                    ` + props.count + `
                    parentCounter: ` + props.parentCounter + `
                    <button data-on-click="increment()">Increment the component</button>
                </div>
                `;  
            }
        }


        var componentCounter = 0;
        var compInstances = {};
        var COMPONENTS = ['COMP2', 'COMP3'];
        var COMPONENT_CONSTR = {COMP2: myComponent2, COMP3: myComponent3};
        var COMPONENT_OBJ = {COMP2: comp3Obj, COMP3: comp3Obj};

        var morphdomCallbacks = {
            childrenOnly: true,
            onNodeAdded: function(node) {
                //console.log('add node', node);
                //console.log(node.tagName)
                if (COMPONENTS.indexOf(node.tagName) != -1) {
                    var key = node.tagName + componentCounter;
                    node.componentId = key;
                    var comp = new Component(node.tagName, comp3Obj);
                    compInstances[key] = new comp(node);
                    //new COMPONENT_CONSTR[node.tagName](node); 
                    console.log('will add a component ' + key);
                    componentCounter++;
                } 
            },

onBeforeNodeAdded: function(node) {
        console.log('want to add note', node);
        //console.trace();
        return node;
    },
 getNodeKey: function(node) {
    var id = node.id;
    if (id) console.log('id', id);
        return id;
    },
            onBeforeElChildrenUpdated: function(fromEl, toEl) {
                console.log('update  children from' + fromEl.tagName + ' to ' + toEl.tagName);
                return true;
            },

            onElUpdated: function(el) {
                console.log('onElUpdated', el);
            },

            onBeforeElUpdated: function(fromEl, toEl) {
                if (fromEl.tagName == 'COMP') {
                    console.warn('you should update', fromEl);
                    var key = fromEl.componentId;
console.log('key', key)
                    compInstances[key].update(context);
                    return false;// todo actually update this node
                }
                console.log('update EL from' + fromEl.tagName + ' to ' + toEl.tagName);
                return true;
            },

            onBeforeNodeDiscarded: function(node) {
                return true;
            },

        };

        var $app = document.getElementById('app');

        var functions = {
            myFn: function(nr, event) {
                console.log('nr' + nr);
                console.log('event', event);
                event.stopPropagation();
                render();
            }

        };

        var counter = 0;
        var context = {title: "My New Post", body: "This is my first post!", counter: counter};

        function render() {
            context.counter++;
            var html = renderApp(context);

            morphdom($app, "<div>" + html + "</div>", morphdomCallbacks);

        }
        render();
      
    </script>


</body>
</html>